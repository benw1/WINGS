#! /usr/bin/env python
import argparse,os,subprocess
from wpipe import *
from stips.observation_module import ObservationModule

def register(PID,task_name):
   myPipe = Store().select('pipelines').loc[int(PID)]
   myTask = Task(task_name,myPipe).create()
   _t = Task.add_mask(myTask,'*','start',task_name)
   _t = Task.add_mask(myTask,'*','new_stips_input','*')
   return

def do_something(job_id,event_id):
   sleep np.random(10)
   return

def parse_all():
    parser = argparse.ArgumentParser()
    parser.add_argument('--R','-R', dest='REG', action='store_true',
                        help='Specify to Register')
    parser.add_argument('--P','-p',type=int,  dest='PID',
                        help='Pipeline ID')
    parser.add_argument('--N','-n',type=str,  dest='task_name',
                        help='Name of Task to be Registered')
    parser.add_argument('--E','-e',type=int,  dest='event_id',
                        help='Event ID')
    parser.add_argument('--J','-j',type=int,  dest='job_id',
                        help='Job ID')
    parser.add_argument('--DP','-dp',type=int,  dest='dp_id',
                        help='Dataproduct ID')
    return parser.parse_args()

   # placeholder for additional steps
   print('done')

if __name__ == '__main__':
   args = parse_all()
   if args.REG:
      _t = register(int(args.PID),str(args.task_name))
   else:
      job_id = int(args.job_id)
      event_id = int(args.event_id)
      do_something(job_id,event_id)
      event = Event.get('id',event_id)
      parent_job = event.getParentJob()
      name = Options.get(event)['name']
      compname = 'completed'+name
      update_option = Options.get(parent_job)[compname]
      update_option = update_option+1
      _update = Options.set(parent_job)[compname:update_option]
      #Event.run_complete(Event.get(int(event_id)))
      #event = Job.getEvent(myJob,'run_stips_completed')
      #Event.fire(event)
      to_run = int(Options.get('event',event_id)['to_run'])
      completed = update_option
      if !(completed<to_run):    
         event = Job.getEvent(myJob,'example2_done',options={'sub_branch':name})
         Event.fire(event)

